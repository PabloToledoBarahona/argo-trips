datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum TripStatus {
  REQUESTED
  OFFERED
  ASSIGNED
  PICKUP_STARTED
  IN_PROGRESS
  COMPLETED
  PAID
  CANCELED
}

enum TripCancelReason {
  RIDER_CANCELLED
  DRIVER_CANCELLED
  NO_SHOW
  SYSTEM_TIMEOUT
  REASSIGN_EXHAUSTED
}

enum TripCancelSide {
  rider
  driver
  system
}

enum TripPointPhase {
  pickup
  in_progress
}

enum ActorType {
  rider
  driver
  system
}

model Trip {
  id          String  @id @default(cuid())
  riderId     String  @map("rider_id")
  driverId    String? @map("driver_id")
  vehicleType String  @map("vehicle_type")

  status TripStatus

  city String

  originLat    Float  @map("origin_lat")
  originLng    Float  @map("origin_lng")
  originH3Res9 String @map("origin_h3_res9")

  destLat    Float  @map("dest_lat")
  destLng    Float  @map("dest_lng")
  destH3Res9 String @map("dest_h3_res9")

  requestedAt     DateTime  @map("requested_at")
  offeredAt       DateTime? @map("offered_at")
  assignedAt      DateTime? @map("assigned_at")
  pickupStartedAt DateTime? @map("pickup_started_at")
  inProgressAt    DateTime? @map("in_progress_at")
  completedAt     DateTime? @map("completed_at")
  paidAt          DateTime? @map("paid_at")

  quoteId         String? @map("quote_id")
  pricingSnapshot Json?   @map("pricing_snapshot")
  paymentIntentId String? @map("payment_intent_id")

  distanceMEst   Int? @map("distance_m_est")
  durationSEst   Int? @map("duration_s_est")
  distanceMFinal Int? @map("distance_m_final")
  durationSFinal Int? @map("duration_s_final")

  cancelReason TripCancelReason? @map("cancel_reason")
  cancelSide   TripCancelSide?   @map("cancel_side")
  cancelAt     DateTime?         @map("cancel_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  points        TripPoint[]
  audits        TripAudit[]
  cancellations TripCancellation[]

  @@index([riderId, requestedAt], map: "idx_trips_rider_requested_at")
  @@index([driverId, status], map: "idx_trips_driver_status")
}

model TripPoint {
  id     String @id @default(cuid())
  tripId String @map("trip_id")
  trip   Trip   @relation(fields: [tripId], references: [id], onDelete: Cascade)

  phase TripPointPhase

  lat    Float
  lng    Float
  h3Res9 String @map("h3_res9")

  speedMps   Float? @map("speed_mps")
  headingDeg Float? @map("heading_deg")

  ts DateTime

  @@index([tripId, ts], map: "idx_trip_points_trip_ts")
}

model TripAudit {
  id     String @id @default(cuid())
  tripId String @map("trip_id")
  trip   Trip   @relation(fields: [tripId], references: [id], onDelete: Cascade)

  action    String
  actorType ActorType @map("actor_type")
  actorId   String?   @map("actor_id")

  payload Json
  ip      String? @map("ip")

  ts DateTime @default(now())

  @@index([tripId, ts], map: "idx_trip_audit_trip_ts")
}

model TripCancellation {
  id     String @id @default(cuid())
  tripId String @map("trip_id")
  trip   Trip   @relation(fields: [tripId], references: [id], onDelete: Cascade)

  side   TripCancelSide   @map("side")
  reason TripCancelReason @map("reason")

  secondsSinceAssign Int?     @map("seconds_since_assign")
  feeAppliedDec      Decimal? @map("fee_applied_dec")

  ts DateTime @default(now())

  @@index([tripId, ts], map: "idx_trip_cancellations_trip_ts")
}
